# QuakeFall Progress — Living State File
# Updated by the agent at end of every session and after every major milestone.
# See docs/anthropic-long-running-agents.md for workflow details.

## Last Updated
2026-02-15 — Session 6-7: Parkour movement system (all 6 mechanics validated)

## What's Done (Phase 1)

### Infrastructure
- ioquake3 engine compiles to WASM via Emscripten (browser client)
- ioquake3 engine compiles natively (dedicated server + desktop client)
- WebSocket↔UDP proxy (proxy.js) bridges browser clients to native server
- IDBFS persistent storage at /q3home for browser client config
- CD key check removed (was blocking browser users)
- HTML template with QuakeFall defaults (demoq3, networking, websocket)

### Titan Mode Phase 1
- /titan console command toggles titan mode
- 500 HP, 1.1x speed, no jumping
- PMF_TITAN flag shared between server and client prediction
- Graceful animation number clamping (prevents BAD ANIMATION crashes)
- MUST use vm_game 0 on server (q3lcc QVM compiler bug corrupts titan bytecode)

### Maps
- Procedural city generator (tools/generate_city_map.py)
- qfcity1.map/bsp — first playable city map (4x4 block grid)
- Full q3map2 compilation pipeline working (BSP/VIS/LIGHT)

### Tooling
- tools/build.sh — native/wasm build wrapper (validated)
- tools/server.sh — server start/stop/restart/status/log (validated)
- tools/rcon.py — RCON client for headless server interaction (validated)
- tools/compile_map.sh — map compile+deploy wrapper (validated)
- features.json — immutable feature contract
- This file (claude-progress.txt) — living state

## What's Done (Phase 2) — Titan Hitbox System (ALL VALIDATED)

All titan-hitbox features validated in-game with native client. All 7 features
in the titan-hitbox category are now "passing" in features.json.

### Validated In-Game:
1. ✅ **titan-child-spawn**: 7 child entities spawn correctly (ent#105-111)
2. ✅ **titan-child-despawn**: Clean entity reuse across 5+ toggle cycles, no leaks
3. ✅ **titan-child-positioning**: Children track parent with yaw-rotated offsets
4. ✅ **titan-debug-rendering**: cg_titanDebug 1 shows colored boxes (red=cockpit, green=torso, blue=arms, yellow=legs, orange=vent)
5. ✅ **titan-debug-command**: /titan_parts and rcon titan_parts both print full entity state
6. ✅ **titan-damage-routing**: Pain callback routes damage with correct multipliers:
   - torso: 1.0x, cockpit: 2.0x, arms: 0.5x, legs: 0.3x, vent: 3.0x
   - Lethal damage correctly kills titan and cleans up parts
7. ✅ **titan-damage-log**: titan_damage_log 1 prints per-hit details to server log

### Key Implementation Details
- Uses `pain` callback (not `die`) for per-hit damage routing
- ET_TITAN_PART custom entity type for clean client-side identification
- Parent titan uses CONTENTS_PLAYERCLIP (blocks movement, passes shots through to children)
- Children use CONTENTS_TITANPART (blocks shots, ignored by movement)
- forcetitan/titan_parts/test_titan_damage rcon commands for automated testing

### Files Modified (external/ioq3 submodule)
- NEW: code/game/bg_titan_parts.h — part type enum, struct, extern table declaration
- NEW: code/game/bg_titan_parts.c — part table definition (shared game+cgame)
- NEW: code/game/g_titan.c — all titan child entity logic
- code/qcommon/surfaceflags.h — CONTENTS_TITANPART (0x0400)
- code/game/bg_public.h — MAX_TITAN_PARTS, ET_TITAN_PART, MASK_SHOT update
- code/game/g_local.h — gclient_s.titanParts[], gentity_s.titanPartType, function declarations
- code/game/g_cmds.c — spawn/despawn in Cmd_Titan_f, titan_parts command dispatch
- code/game/g_active.c — G_UpdateTitanParts call in per-frame titan block
- code/game/g_combat.c — G_DespawnTitanParts on player death
- code/game/g_client.c — G_DespawnTitanParts on disconnect
- code/game/g_main.c — G_InitTitanCvars call
- code/game/g_svcmds.c — forcetitan, titan_parts, test_titan_damage server commands
- code/cgame/cg_ents.c — ET_TITAN_PART case + titan debug box rendering
- code/cgame/cg_main.c — cg_titanDebug cvar declaration + registration
- code/cgame/cg_local.h — cg_titanDebug extern
- code/cgame/cg_consolecmds.c — titan_parts command for tab completion
- cmake/basegame.cmake — bg_titan_parts.c + g_titan.c added to build

### Parent Repo Changes
- tools/build.sh — also copies .so files to demoq3 (not just QVMs)
- gamedata/scripts/quakefall.shader — custom 3D debug shader source

## What's Done (Session 3) — Titan Gameplay Tuning & Bug Fixes

Focused on making titans feel right to play and fixing rendering/network bugs
that prevented the hitbox debug visualization from working in browser multiplayer.

### Titan Scaling & Feel
- Scaled titan ~1.73x total (two rounds: +33% then +30%)
- Final dimensions: ±52 width, 346 height, 260 viewheight
- Player model positioned at upper chest/vent height (RENDER_OFFSET 225)
- Speed increased from 0.6x to 1.1x — titans now slightly faster than pilots

### Bug Fixes
- **Debug shader**: whiteShader is 2D-only, doesn't work with trap_R_AddPolyToScene.
  Created titanDebug shader with rgbGen vertex + alphaGen vertex + blendFunc
- **eFlags network truncation**: EF_TITAN (bit 20) was silently truncated —
  entityState_t.eFlags was 19 bits, playerState_t.eFlags was 16 bits.
  Widened both to 24 bits in msg.c. This caused the player model elevation
  (TITAN_RENDER_OFFSET) to never reach clients.
- **Stale QVM builds**: cmake doesn't track header deps for q3lcc. Changing
  bg_public.h doesn't trigger QVM rebuild. Must delete qvm.dir/ manually.
- **WASM shader delivery**: Added quakefall.shader to client-config.json so
  browser client downloads it to the virtual filesystem
- **Own-part filtering**: Skip rendering own titan debug boxes in first-person
  (camera was inside them). Uses otherEntityNum for ownership identification.
- **SVF_BROADCAST**: Titan part entities now broadcast to all clients regardless
  of PVS, ensuring reliable hitbox visibility in multiplayer

## What's Done (Session 4) — Titan Animation (VALIDATED)

Both titan-animation features validated in-game with native client.

### Crouch Compression (titan-crouch)
- Titan crouching compresses all hitbox parts vertically (Z-axis) proportionally
- Crouch scale: 62.7% of standing height (TITAN_CROUCH_HEIGHT / TITAN_HEIGHT)
- Smooth lerp transition (TITAN_CROUCH_RATE = 8.0, ~125ms full transition)
- Communicated to client via es->frame (0-100 integer) for debug rendering sync
- Server-side collision boxes updated correctly (r.mins/r.maxs scaled)
- Validated: crouchFrac=1.00 → Z positions compressed, bboxes scaled, frame=100

### Walk Animation (titan-walk-animation)
- Procedural leg/arm swinging during movement (sin oscillation)
- Legs swing forward/back alternately, arms counter-swing (natural gait)
- Phase accumulates proportionally to horizontal speed
- Amplitude normalized by run speed (320 units/s), clamped to [0,1]
- Returns to idle pose when stationary (zero amplitude)
- Walk parameters: leg amp=40, arm amp=25, phase rate=0.008

### Files Modified (external/ioq3 submodule)
- code/game/g_local.h — Added titanCrouchFrac and titanWalkPhase fields
- code/game/g_titan.c — Rewrote G_UpdateTitanParts with crouch scaling + walk animation
- code/game/g_svcmds.c — Enhanced titan_parts server command with crouchFrac/walkPhase output
- code/cgame/cg_ents.c — Updated CG_DrawTitanPartDebug for crouch-compressed debug boxes

## What's Done (Session 5) — Titan Enter/Exit Flow (ALL VALIDATED)

All 4 titan enter/exit features validated in-game with native client.

### Calltitan (titan-entity-callin)
- `/calltitan` spawns ET_GENERAL pod entity 2000 units above player
- Pod descends at 400 u/s via TR_LINEAR trajectory
- TitanPodThink traces from prev→current position each frame for ground detection
- On landing: snaps to ground, becomes CONTENTS_SOLID, stops thinking
- Validates: alive, not titan, no active pod, cooldown expired
- Pod cleanup on ClientDisconnect

### Embark (titan-embark)
- `/embark` teleports player to landed pod, frees pod, enters titan mode
- Validates: alive, not titan, has pod, pod landed (TR_STATIONARY), within 128 range
- Uses new G_EnterTitanMode helper (sets health, spawns parts, notifies)

### Disembark (titan-disembark)
- `/disembark` finds safe eject position and exits titan mode
- G_FindEjectPosition tries 4 cardinal directions (yaw-relative), then up, then fallback
- Sets pilot health to 100 after exit
- Uses new G_ExitTitanMode helper (despawns parts, restores normal state)

### Titan Destruction (titan-destruction)
- When titan health reaches 0, player_die calls G_TitanDestroyed instead of normal death
- Awards kill credit (AddScore) and broadcasts obituary
- Ejects pilot alive with 100 HP at safe position
- Starts 30s cooldown (titanCooldownTime) preventing calltitan
- The `return` in player_die prevents normal death processing (no body, no respawn timer)

### Refactored Helpers
- G_EnterTitanMode: extracted from Cmd_Titan_f, reused by embark
- G_ExitTitanMode: extracted from Cmd_Titan_f, reused by disembark and destruction
- Cmd_Titan_f (debug /titan) now delegates to these helpers

### RCON Test Commands
- forcecalltitan <client>, forceembark <client>, forcedisembark <client>
- Debug output in forceembark shows pod/player positions and distance

### Pod Debug Rendering
- cg_titanDebug shows white translucent box for pod entities (ET_GENERAL + TITAN_POD_TAG)
- Pod position interpolated from trajectory for smooth rendering during descent

### Files Modified (external/ioq3 submodule)
- code/game/g_titan.c — G_EnterTitanMode, G_ExitTitanMode, G_FindEjectPosition, G_TitanDestroyed, TitanPodThink, Cmd_CallTitan_f, Cmd_Embark_f, Cmd_Disembark_f
- code/game/g_local.h — titanPod, titanCooldownTime fields + new function declarations
- code/game/bg_public.h — Pod constants (speed, height, range, cooldown, tag, pilot health)
- code/game/g_cmds.c — Refactored Cmd_Titan_f, dispatch calltitan/embark/disembark
- code/game/g_combat.c — player_die calls G_TitanDestroyed + return (prevents normal death)
- code/game/g_client.c — Pod cleanup on disconnect
- code/game/g_svcmds.c — forcecalltitan, forceembark, forcedisembark RCON commands
- code/cgame/cg_consolecmds.c — trap_AddCommand for calltitan/embark/disembark
- code/cgame/cg_ents.c — CG_DrawTitanPodDebug for pod debug rendering

## What's Done (Session 6-7) — Parkour Movement System (ALL VALIDATED)

All 8 parkour features validated via server-side RCON test sequencer + visual recording.
14 assertions passed, 0 failed across all 6 mechanics.

### Mechanics Implemented (bg_pmove.c)
1. **Wall Run** — Airborne + near wall + forward + fast → run along wall with reduced gravity
   - Side traces detect wall, velocity projected onto wall plane each frame
   - Adhesion pull (pm_wallrunPull) keeps player attached through bumps
   - Duration tracked via ps->generic1, reduced each frame
2. **Wall Jump** — Jump during wall run → kick off with perpendicular + upward force
   - 300ms cooldown (negative generic1) prevents immediate re-attachment
3. **Double Jump** — Jump while airborne → weaker second jump (PMF_DOUBLEJUMP consumed)
   - Flag cleared on landing, one per air time
4. **Crouch Slide** — Crouch while fast on ground → reduced friction slide
   - Friction multiplied by pm_slideFriction (default 0.5) when speed > pm_slideMinSpeed
5. **Vault** — Forward into waist-height obstacle on ground → teleport on top
   - Multi-height trace detection (knee, waist, chest heights)
   - Room check uses correct player-origin-on-ledge position
   - Forward trace nudged 2 units past impact for top surface detection
6. **Ledge Grab** — Airborne + forward into chest-height ledge → grab and climb
   - Sets climb velocity, brief pm_time lockout, kills horizontal momentum

### Server-Side Test Sequencer (g_parkour_test.c)
- RCON command `test_parkour <name> <client>` runs frame-accurate test sequences
- Step flags: teleport, set velocity, override usercmd, lock yaw, assert flags/speed/height/airborne
- Overrides usercmd in ClientThink_real before Pmove for precise input control
- View angle locking via SetClientViewAngle every frame prevents client drift
- 6 test definitions: doublejump(7 steps), wallrun(7), walljump(7), slide(5), vault(4), ledgegrab(4)

### Parkour Test Map (parkour1)
- Generated by tools/generate_parkour_map.py
- 9 sections: wall run straightaway, wall run curve, wall chain corridor,
  double jump gaps, slide tunnel, ledge grab tower, vault course, mixed course, tuning arena

### 16 Tunable Cvars
- Wall run: pm_wallrunMinSpeed, pm_wallrunDuration, pm_wallrunGravity, pm_wallrunPull, pm_wallrunUpForce, pm_wallrunDetectDist
- Wall jump: pm_walljumpForce, pm_walljumpUpForce
- Double jump: pm_doublejumpVelocity
- Slide: pm_slideMinSpeed, pm_slideFriction
- Ledge grab: pm_ledgeGrabRange, pm_ledgeGrabHeight, pm_ledgeClimbSpeed
- Vault: pm_vaultMaxHeight, pm_vaultSpeed

### Key Bug Fixes During Validation
- **Wall jump re-attachment**: Added 300ms cooldown via negative generic1
- **Vault trace too high**: Added knee-height (0.4x) forward trace for short obstacles
- **Vault room check**: Fixed startsolid by computing correct player-on-ledge position
- **Top trace offset**: Forward trace hit wall face, needed 2-unit nudge past impact for top detection
- **Teleport airborne flicker**: Increased settle duration + negative z velocity for reliable grounding

### Visual Test Recording
- tests/parkour_rcon_tests.test — runs all 6 RCON tests with recording
- tests/recordings/parkour_rcon_tests.gif/.mp4 — proof of validation

### Files Modified (external/ioq3 submodule)
- NEW: code/game/g_parkour_test.c — server-side parkour test sequencer
- code/game/bg_pmove.c — all 6 mechanics, 16 cvar globals, PM_CheckWallRun, PM_CheckMantle
- code/game/bg_public.h — PMF_WALLRUN(4), PMF_DOUBLEJUMP(128), PLAYER_WIDTH(15)
- code/game/bg_local.h — parkour cvar externs
- code/game/g_local.h — test function prototypes
- code/game/g_active.c — G_ParkourTestOverrideCmd hook, G_SyncParkourCvars call
- code/game/g_main.c — G_ParkourTestFrame hook
- code/game/g_svcmds.c — test_parkour RCON command
- cmake/basegame.cmake — g_parkour_test.c in GAME_SOURCES

### Parent Repo Changes
- NEW: tools/generate_parkour_map.py — parkour test map generator
- NEW: tests/parkour_rcon_tests.test — RCON test sequence visual test
- maps/parkour1.map — generated parkour test map

## Next Steps

### Future (Not Yet Scoped)
- Pilot weapons + titan weapons
- Map iteration (vertical gameplay, pilot-only alleys)

## Blockers / Known Issues
- q3lcc QVM compiler corrupts titan-related bytecode — server MUST use vm_game 0
- q3lcc also can't handle extern const properly — split bg_titan_parts into .h/.c to avoid duplicate symbol errors
- Client QVMs (cgame, ui) compile fine, only qagame.qvm is affected
- Duplicate ioq3ded processes cause network corruption — always check before starting

## Discoveries (Cumulative)
- q3lcc QVM compiler doesn't handle `extern const` properly — emits definitions in every translation unit
- q3lcc is strict about const pointer conversions — can't pass `const vec3_t` where `vec3_t` is expected
- CONTENTS_PLAYERCLIP is in MASK_PLAYERSOLID but NOT in MASK_SHOT — enables the collision strategy
- ET_TITAN_PART must be handled in cgame's CG_AddCEntity switch or client crashes with "Bad entity type"
- `die` callback only fires at health<=0; use `pain` callback for per-hit damage routing
- build.sh must copy .so files (not just QVMs) to demoq3/ or server loads stale game logic
- Part count of 7 is conservative; engine can handle 15-30 per titan comfortably
- whiteShader is 2D only — 3D scene polys need custom shader with rgbGen vertex
- eFlags network fields silently truncate bits beyond their width — no error, just zeros
- cmake does NOT track .h deps for QVM builds — must nuke qvm.dir/ when headers change
- Loose files (shaders, BSPs) need explicit entries in client-config.json for WASM delivery
