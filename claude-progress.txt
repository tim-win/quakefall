# QuakeFall Progress — Living State File
# Updated by the agent at end of every session and after every major milestone.
# See docs/anthropic-long-running-agents.md for workflow details.

## Last Updated
2026-02-14 — Third session: titan gameplay tuning, rendering/network bug fixes

## What's Done (Phase 1)

### Infrastructure
- ioquake3 engine compiles to WASM via Emscripten (browser client)
- ioquake3 engine compiles natively (dedicated server + desktop client)
- WebSocket↔UDP proxy (proxy.js) bridges browser clients to native server
- IDBFS persistent storage at /q3home for browser client config
- CD key check removed (was blocking browser users)
- HTML template with QuakeFall defaults (demoq3, networking, websocket)

### Titan Mode Phase 1
- /titan console command toggles titan mode
- 500 HP, 1.1x speed, no jumping
- PMF_TITAN flag shared between server and client prediction
- Graceful animation number clamping (prevents BAD ANIMATION crashes)
- MUST use vm_game 0 on server (q3lcc QVM compiler bug corrupts titan bytecode)

### Maps
- Procedural city generator (tools/generate_city_map.py)
- qfcity1.map/bsp — first playable city map (4x4 block grid)
- Full q3map2 compilation pipeline working (BSP/VIS/LIGHT)

### Tooling
- tools/build.sh — native/wasm build wrapper (validated)
- tools/server.sh — server start/stop/restart/status/log (validated)
- tools/rcon.py — RCON client for headless server interaction (validated)
- tools/compile_map.sh — map compile+deploy wrapper (validated)
- features.json — immutable feature contract
- This file (claude-progress.txt) — living state

## What's Done (Phase 2) — Titan Hitbox System (ALL VALIDATED)

All titan-hitbox features validated in-game with native client. All 7 features
in the titan-hitbox category are now "passing" in features.json.

### Validated In-Game:
1. ✅ **titan-child-spawn**: 7 child entities spawn correctly (ent#105-111)
2. ✅ **titan-child-despawn**: Clean entity reuse across 5+ toggle cycles, no leaks
3. ✅ **titan-child-positioning**: Children track parent with yaw-rotated offsets
4. ✅ **titan-debug-rendering**: cg_titanDebug 1 shows colored boxes (red=cockpit, green=torso, blue=arms, yellow=legs, orange=vent)
5. ✅ **titan-debug-command**: /titan_parts and rcon titan_parts both print full entity state
6. ✅ **titan-damage-routing**: Pain callback routes damage with correct multipliers:
   - torso: 1.0x, cockpit: 2.0x, arms: 0.5x, legs: 0.3x, vent: 3.0x
   - Lethal damage correctly kills titan and cleans up parts
7. ✅ **titan-damage-log**: titan_damage_log 1 prints per-hit details to server log

### Key Implementation Details
- Uses `pain` callback (not `die`) for per-hit damage routing
- ET_TITAN_PART custom entity type for clean client-side identification
- Parent titan uses CONTENTS_PLAYERCLIP (blocks movement, passes shots through to children)
- Children use CONTENTS_TITANPART (blocks shots, ignored by movement)
- forcetitan/titan_parts/test_titan_damage rcon commands for automated testing

### Files Modified (external/ioq3 submodule)
- NEW: code/game/bg_titan_parts.h — part type enum, struct, extern table declaration
- NEW: code/game/bg_titan_parts.c — part table definition (shared game+cgame)
- NEW: code/game/g_titan.c — all titan child entity logic
- code/qcommon/surfaceflags.h — CONTENTS_TITANPART (0x0400)
- code/game/bg_public.h — MAX_TITAN_PARTS, ET_TITAN_PART, MASK_SHOT update
- code/game/g_local.h — gclient_s.titanParts[], gentity_s.titanPartType, function declarations
- code/game/g_cmds.c — spawn/despawn in Cmd_Titan_f, titan_parts command dispatch
- code/game/g_active.c — G_UpdateTitanParts call in per-frame titan block
- code/game/g_combat.c — G_DespawnTitanParts on player death
- code/game/g_client.c — G_DespawnTitanParts on disconnect
- code/game/g_main.c — G_InitTitanCvars call
- code/game/g_svcmds.c — forcetitan, titan_parts, test_titan_damage server commands
- code/cgame/cg_ents.c — ET_TITAN_PART case + titan debug box rendering
- code/cgame/cg_main.c — cg_titanDebug cvar declaration + registration
- code/cgame/cg_local.h — cg_titanDebug extern
- code/cgame/cg_consolecmds.c — titan_parts command for tab completion
- cmake/basegame.cmake — bg_titan_parts.c + g_titan.c added to build

### Parent Repo Changes
- tools/build.sh — also copies .so files to demoq3 (not just QVMs)
- gamedata/scripts/quakefall.shader — custom 3D debug shader source

## What's Done (Session 3) — Titan Gameplay Tuning & Bug Fixes

Focused on making titans feel right to play and fixing rendering/network bugs
that prevented the hitbox debug visualization from working in browser multiplayer.

### Titan Scaling & Feel
- Scaled titan ~1.73x total (two rounds: +33% then +30%)
- Final dimensions: ±52 width, 346 height, 260 viewheight
- Player model positioned at upper chest/vent height (RENDER_OFFSET 225)
- Speed increased from 0.6x to 1.1x — titans now slightly faster than pilots

### Bug Fixes
- **Debug shader**: whiteShader is 2D-only, doesn't work with trap_R_AddPolyToScene.
  Created titanDebug shader with rgbGen vertex + alphaGen vertex + blendFunc
- **eFlags network truncation**: EF_TITAN (bit 20) was silently truncated —
  entityState_t.eFlags was 19 bits, playerState_t.eFlags was 16 bits.
  Widened both to 24 bits in msg.c. This caused the player model elevation
  (TITAN_RENDER_OFFSET) to never reach clients.
- **Stale QVM builds**: cmake doesn't track header deps for q3lcc. Changing
  bg_public.h doesn't trigger QVM rebuild. Must delete qvm.dir/ manually.
- **WASM shader delivery**: Added quakefall.shader to client-config.json so
  browser client downloads it to the virtual filesystem
- **Own-part filtering**: Skip rendering own titan debug boxes in first-person
  (camera was inside them). Uses otherEntityNum for ownership identification.
- **SVF_BROADCAST**: Titan part entities now broadcast to all clients regardless
  of PVS, ensuring reliable hitbox visibility in multiplayer

## Next Steps

### Immediate: Titan Enter/Exit Flow (Phase 3)
- /calltitan — spawn titan from sky
- /embark — enter a landed titan
- /disembark — exit titan as pilot
- Titan destruction — force-eject pilot on death

### Future (Not Yet Scoped)
- Parkour movement (wall run, wall jump, slide) — extends bg_pmove.c
- Pilot weapons + titan weapons
- Map iteration (vertical gameplay, pilot-only alleys)

## Blockers / Known Issues
- q3lcc QVM compiler corrupts titan-related bytecode — server MUST use vm_game 0
- q3lcc also can't handle extern const properly — split bg_titan_parts into .h/.c to avoid duplicate symbol errors
- Client QVMs (cgame, ui) compile fine, only qagame.qvm is affected
- Duplicate ioq3ded processes cause network corruption — always check before starting

## Discoveries (Cumulative)
- q3lcc QVM compiler doesn't handle `extern const` properly — emits definitions in every translation unit
- q3lcc is strict about const pointer conversions — can't pass `const vec3_t` where `vec3_t` is expected
- CONTENTS_PLAYERCLIP is in MASK_PLAYERSOLID but NOT in MASK_SHOT — enables the collision strategy
- ET_TITAN_PART must be handled in cgame's CG_AddCEntity switch or client crashes with "Bad entity type"
- `die` callback only fires at health<=0; use `pain` callback for per-hit damage routing
- build.sh must copy .so files (not just QVMs) to demoq3/ or server loads stale game logic
- Part count of 7 is conservative; engine can handle 15-30 per titan comfortably
- whiteShader is 2D only — 3D scene polys need custom shader with rgbGen vertex
- eFlags network fields silently truncate bits beyond their width — no error, just zeros
- cmake does NOT track .h deps for QVM builds — must nuke qvm.dir/ when headers change
- Loose files (shaders, BSPs) need explicit entries in client-config.json for WASM delivery
